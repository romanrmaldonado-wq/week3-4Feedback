<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>One-time Firestore Migration (Root → offices/NJPOWER)</title>
  <style>
    body { margin:0; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif; background:#0b1220; color:#e2e8f0; }
    .wrap { max-width:900px; margin:0 auto; padding:22px; }
    .card { background:#ffffff; color:#0f172a; border-radius:16px; padding:16px; box-shadow:0 12px 30px rgba(0,0,0,.25); }
    h1 { margin:0 0 6px; font-size:22px; }
    p { margin:8px 0; line-height:1.35; }
    .muted { color:#64748b; }
    .row { display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; }
    button {
      border:0; border-radius:12px; padding:10px 14px; font-weight:700;
      cursor:pointer; background:#1f2937; color:#fff;
    }
    button.primary { background:#c9f36a; color:#0b1220; }
    button:disabled { opacity:.55; cursor:not-allowed; }
    code, pre { background:#0b1220; color:#e2e8f0; border-radius:12px; padding:12px; display:block; overflow:auto; }
    pre { margin:12px 0 0; max-height:420px; }
    .warn { color:#b91c1c; font-weight:800; }
    ul { margin:8px 0 0 18px; }
    small { color:#94a3b8; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>One-time Migration: Root Collections → <code style="display:inline;background:#eef2ff;color:#111827;padding:4px 8px;border-radius:10px;">offices/NJPOWER</code></h1>

      <p class="muted">
        This page will <b>copy</b> (not delete) your existing docs from:
      </p>
      <ul class="muted">
        <li><code>/teams</code></li>
        <li><code>/rookies</code></li>
        <li><code>/mentors</code></li>
        <li><code>/feedbacks</code></li>
      </ul>
      <p class="muted">
        into:
      </p>
      <ul class="muted">
        <li><code>/offices/NJPOWER/teams</code></li>
        <li><code>/offices/NJPOWER/rookies</code></li>
        <li><code>/offices/NJPOWER/mentors</code></li>
        <li><code>/offices/NJPOWER/feedbacks</code></li>
      </ul>

      <p class="warn">
        This page will refuse to run unless it is connected to project <b>week-3-and-4-feedback-form</b>.
      </p>

      <div class="row">
        <button id="dry">Dry Run (count only)</button>
        <button class="primary" id="run">Run Migration (copy)</button>
      </div>
      <p class="muted"><small>Safe to run more than once — it uses merge writes. Do not delete the root collections until you confirm everything looks correct.</small></p>

      <pre id="log"></pre>
    </div>
  </div>

  <!-- Firebase compat (matches your working app) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

  <script>
    const logEl = document.getElementById("log");
    const log = (...args) => {
      const line = args.map(a => (typeof a === "string" ? a : JSON.stringify(a, null, 2))).join(" ");
      console.log(line);
      logEl.textContent += line + "\n";
    };

    // Firebase config copied from your index-FINAL-FIXED.html
    const firebaseConfig = {
            apiKey: "AIzaSyAw_O85ErUC-_m3UozqOUETQdHGr7UtfEQ",
            authDomain: "week-3-and-4-feedback-form.firebaseapp.com",
            projectId: "week-3-and-4-feedback-form",
            storageBucket: "week-3-and-4-feedback-form.firebasestorage.app",
            messagingSenderId: "438693244020",
            appId: "1:438693244020:web:ee0c6afd67bf51dc023521"
        };

    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const PROJECT_REQUIRED = "week-3-and-4-feedback-form";
    const OFFICE_ID = "NJPOWER";
    const COLLECTIONS = ["teams","rookies","mentors","feedbacks"];

    async function countDocs(colRef) {
      const snap = await colRef.get();
      return snap.size;
    }

    async function copyCollection(colName) {
      log("\n=== Copying " + colName + " ===");
      const srcRef = db.collection(colName);
      const destRef = db.collection("offices").doc(OFFICE_ID).collection(colName);

      const snap = await srcRef.get();
      log("Found " + snap.size + " docs in /" + colName);

      let batch = db.batch();
      let batchCount = 0;
      let copied = 0;

      for (const doc of snap.docs) {
        batch.set(destRef.doc(doc.id), doc.data(), { merge: true });
        copied++;
        batchCount++;

        // stay under 500 batch limit
        if (batchCount >= 450) {
          await batch.commit();
          log("Committed " + copied + " / " + snap.size + " ...");
          batch = db.batch();
          batchCount = 0;
        }
      }

      if (batchCount > 0) {
        await batch.commit();
      }

      log("Done: /" + colName + " → /offices/" + OFFICE_ID + "/" + colName + " (copied/merged " + copied + ")");
    }

    async function dryRun() {
      logEl.textContent = "";
      const pid = firebase.app().options.projectId;
      log("Connected projectId:", pid);

      if (pid !== PROJECT_REQUIRED) {
        log("❌ STOP: Wrong project. Expected:", PROJECT_REQUIRED);
        return;
      }

      log("\nRoot collection counts:");
      for (const c of COLLECTIONS) {
        const n = await countDocs(db.collection(c));
        log("- /" + c + ": " + n);
      }

      log("\nOffice (" + OFFICE_ID + ") collection counts:");
      for (const c of COLLECTIONS) {
        const n = await countDocs(db.collection("offices").doc(OFFICE_ID).collection(c));
        log("- /offices/" + OFFICE_ID + "/" + c + ": " + n);
      }

      log("\n✅ Dry run complete.");
    }

    async function runMigration() {
      logEl.textContent = "";
      const pid = firebase.app().options.projectId;
      log("Connected projectId:", pid);

      if (pid !== PROJECT_REQUIRED) {
        log("❌ STOP: Wrong project. Expected:", PROJECT_REQUIRED);
        return;
      }

      await db.collection("offices").doc(OFFICE_ID).set({
        name: "NJ Power",
        migratedAt: firebase.firestore.FieldValue.serverTimestamp()
      }, { merge: true });

      for (const c of COLLECTIONS) {
        await copyCollection(c);
      }

      log("\n✅ Migration complete.");
      log("Next: deploy your office-selector app and choose NJPOWER to see the copied data.");
    }

    const dryBtn = document.getElementById("dry");
    const runBtn = document.getElementById("run");

    dryBtn.addEventListener("click", async () => {
      dryBtn.disabled = true; runBtn.disabled = true;
      try { await dryRun(); } catch (e) { log("❌ Error:", e.message || e); }
      dryBtn.disabled = false; runBtn.disabled = false;
    });

    runBtn.addEventListener("click", async () => {
      if (!confirm("This will COPY root data into offices/NJPOWER. Continue?")) return;
      dryBtn.disabled = true; runBtn.disabled = true;
      try { await runMigration(); } catch (e) { log("❌ Error:", e.message || e); }
      dryBtn.disabled = false; runBtn.disabled = false;
    });
  </script>
</body>
</html>
